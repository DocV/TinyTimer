<!doctype html>
<html>
	<head>
		<title>Tiny Timer</title>
		<meta charset="utf-8" />
		<link rel="shortcut icon" type="image/png" href="favicon.png" />
		<script type="text/javascript">
			function increment(){
				timers.forEach(function(current, index, array) {
					if (current.enabled){
						current.time++;
						current.clock.textContent = formatTime(current.time);
						if (current.alarmEnabled && !current.alarmFired){
							checkAlarm(index);
						}						
					}
				})
			}
			var timers = [];
			
			function formatTime(time) {
				var hours = Math.floor(time / 3600)
				var output = (hours < 10 ? "0" : "") + hours + ":";
				var minutes = Math.floor((time % 3600) / 60)
				output += (minutes < 10 ? "0" : "") + minutes + ":";
				var seconds = time % 60
				output += (seconds < 10 ? "0" : "") + seconds;
				return output;
			}
			
			function loadTimers(){
				var timerElements = document.getElementsByClassName("timer");
				
				Array.from(timerElements).forEach(function(current, index, array) {
					timers[index] = {}
					timers[index].container = current;
					timers[index].time = 0;
					timers[index].alarmTime = 0;
					timers[index].enabled = false;
					timers[index].clock = current.getElementsByClassName("clock")[0];
					timers[index].alarm = current.getElementsByClassName("alarm")[0];
					timers[index].alarmEnabled = false;
					timers[index].alarmFired = false;
				})
				
				window.setInterval(increment, 1000)
			}
			
			function checkAlarm(id){
				console.log("checking alarm");
				var timer = timers[id];
				if (timer.time > timer.alarmTime){
					timer.alarm.style.color = "red";
					timer.alarmFired = true;
				}
			}
			
			function startTimer(id){
				timers[id].enabled = true;
			}
			
			function stopTimer(id){
				timers[id].enabled = false;
			}
			
			function resetTimer(id){
				timers[id].time = 0;
				timers[id].clock.textContent = formatTime(0);
				timers[id].alarm.style.color = "black";
				timers[id].alarmFired = false;
			}
			
			function adjustAlarm(id, amount) {
				timers[id].alarmTime += amount;
				if (timers[id].alarmTime < 0){
					timers[id].alarmTime = 0;
				}
				timers[id].alarm.textContent = formatTime(timers[id].alarmTime);
				timers[id].alarm.style.color = "black";
				timers[id].alarmFired = false;
			}
			
			function toggleAlarm(event, id){
				timers[id].alarmEnabled = !timers[id].alarmEnabled;
				if (timers[id].alarmEnabled){
					event.target.textContent = "Alarm is on";
				}
				else {
					event.target.textContent = "Alarm is off";
				}
			}
		</script>
	</head>
	<body onload="loadTimers()">
		<table id="timer_container">
			<tbody class="timer" id="timer0">
				<tr class="timertop" id="timer0top">
					<td><div class="clock" id="t0time">00:00:00</div></td>
					<td><button id="t0start" onclick="startTimer(0)">Start</button></td>
					<td><button id="t0stop" onclick="stopTimer(0)">Stop</button></td>
					<td><button id="t0reset" onclick="resetTimer(0)">Reset</button></td>
				</tr>
				<tr class="timerbottom" id="timer0bottom">
					<td><div class="alarm" id="t0alarm">00:00:00</div></td>
					<td>
						<button id="t0h+" onclick="adjustAlarm(0, 3600)">H+</button>
						<button id="t0h-" onclick="adjustAlarm(0, -3600)")>H-</button>
					</td>
					<td>
						<button id="t0m+" onclick="adjustAlarm(0, 60)">M+</button>
						<button id="t0m-" onclick="adjustAlarm(0, -60)">M-</button>
					</td>
					<td>
						<button id="t0s+" onclick="adjustAlarm(0, 1)">S+</button>
						<button id="t0s-" onclick="adjustAlarm(0, -1)">S-</button>
					</td>
					<td>
						<button id="t0alarmtoggle" onclick="toggleAlarm(event, 0)">Alarm is off</button>
					</td>
				</tr>
			</tbody>
		</table>
	</body>
</html>